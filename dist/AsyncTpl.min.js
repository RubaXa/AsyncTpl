(function(T,F){function p(a,c){K[a.replace(L,"")]=c}function n(a){return K[a.replace(L,"")]}var L=/^.+\//,K={};p("fs",{readFile:function(a,c,b){jQuery.ajax({url:a,type:"get",dataType:"text",isLocal:!0,success:function(a){b(null,a)}})},readFileSync:function(a){return jQuery.ajax({url:a,type:"get",async:!1,dataType:"text",isLocal:!0}).responseText},lstatSync:function(){return{mtime:0}}});var z=n("./utils"),o=function(a,c,b,e){if(!(this instanceof o))return new o(a,c,b,e);if("number"===typeof a)switch(e=
b,b=c,c=a,c){case o.TEXT_NODE:a="<text>";break;case o.CDATA_NODE:a="<cdata>";break;case o.COMMENT_NODE:a="<comment>";break;case o.CUSTOM_NODE:a="<custom>"}else a=a.toLowerCase(),a.match(U)&&(this.ns=RegExp.$1,a=RegExp.$2);this.name=a;this.type=c;this.value=b;this.attributes=e||{};this.childNodes=[]},U=/^([^:]+):(.+)/,l={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_NODE:4,COMMENT_NODE:8,CUSTOM_NODE:20,COMPILER_NODE:21,VAR_NODE:22},V={area:!0,base:!0,br:!0,col:!0,command:!0,embed:!0,hr:!0,img:!0,
input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,wbr:!0};o.prototype={constructor:o,attr:function(a,c){if(this.attributes[a])return this.attributes[a].value;z.exception('Tag "'+this.name+'", attribute "'+(c||a)+'" is missing',this.__line,this.__file)},attrAny:function(a,c){var b;z.each(a.split(" "),function(a){b=b||this.attributes[a]},this);c&&!b&&this.attr(c);return b&&b.value},addAttr:function(a,c){this.attributes[a]=o(a,o.ATTRIBUTE_NODE,c)},removeAttr:function(a){delete this.attributes[a]},
c:function(a,c,b,e,d){return this.clone(a,c,o.COMPILER_NODE,b,e,d)},clone:function(a,c,b,e,d,g){c=o(c,this.type,c.value);c.ns=a;c.type=b;c.value=g;c.__line=this.__line;c.__file=this.__file;c.__open=!d;c.__close=!!d;z.each(e,function(a,b){c.attributes[b]=o(b,o.ATTRIBUTE_NODE,a)});return c},isShort:function(){return!0===V[this.name]}};for(var G in l)o[G]=o.prototype[G]=l[G];o.trace=function(a,c){var b="";z.each(a,function(a){!a.__empty&&a.__close&&(b=b.substr(0,b.length-3));var d=b+c.left+(a.__close?
"/":"")+(a.ns?a.ns+":":"")+a.name;"string"==typeof a.attributes?d+=a.attributes:z.each(a.attributes,function(a,b){d=d+(" "+b+'="'+a.value+'"')});console.log(d+c.right);!a.__empty&&a.__open&&(b+="   ")},this)};o.findClosureIdx=function(a,c,b){if(!c.__close)for(var b=b|0,e=a.length,d=0,g;b<e;b++)if(g=a[b],c.name==g.name&&(d+=g.__close?-1:1,g.__close&&1>d))return b};"undefined"!==typeof p?p("./Node",o):module.exports=o;var w=n("fs"),s=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},
r=function(a){if(!(this instanceof r))return new r(a);var c=[],b=[],e,d,g=!0,f=!0,i=!1,q=this;q.done=function(a){g&&a&&(i?a(d):c.push(a));return q};q.fail=function(a){f&&a&&(i?a(d):b.push(a));return q};q.then=function(a,b){return q.done(a).fail(b)};q.reject=function(a){g=!1;i=!0;for(d=a;b.length;)b.shift()(a);return q};q.resolve=function(a){f=!1;i=!0;for(d=a;c.length;)c.shift()(a);return q};q.promise=function(){void 0===e&&(e={done:q.done,fail:q.fail,then:q.then,promise:q.promise});return e};void 0!==
a&&a(q)},W={}.toString,M="".trim,X=/^#/,N=[].slice,Y=/^\s+/,Z=/\s+$/,$=/[&<>"]/g,aa=/&/g,ba=/>/g,ca=/</g,da=/"/g,ea=/'/g,x="undefined"!==typeof console&&console,j={mods:{},Array:function(a){a=a||[];a.map=a.map||function(a){for(var b=[],e=0,d=this.length;e<d;e++)b.push(a(this[e]));return b};a.add=function(a,b,e){a.__order=~~e;void 0===b?this.push(a):0==b?this.unshift(a):this.splice(b,0,a);return this};a.addOrder=function(a,b){return this.add(a,void 0,b)};a.addMulti=function(a,b){a.length&&this.splice.apply(this,
[b,0].concat(a));return this};a.order=function(){this.sort(function(a,b){return a.__order-b.__order});return this};return a},$:function(a){return"string"==typeof a?document.getElementById(a.replace(X,"")):a},sizeof:function(a){var c=0;if(a&&(j.isArray(a)||"object"==typeof a))"length"in a?c=a.length:j.each(a,function(){c++});return c},isArray:function(a){return"[object Array]"==W.call(a)},uniqId:function(){return s()+s()+"-"+s()+"-"+s()+"-"+s()+"-"+s()+s()+s()},ns:function(a,c,b){var c=c.split("."),
e=c.pop();j.each(c,function(b){a[b]||(a[b]={});a=a[b]});a[e]=b},escape:function(a){"string"===typeof a&&$.test(a)&&(~a.indexOf("&")&&(a=a.replace(aa,"&amp;")),~a.indexOf("<")&&(a=a.replace(ca,"&lt;")),~a.indexOf(">")&&(a=a.replace(ba,"&gt;")),~a.indexOf('"')&&(a=a.replace(da,"&quot;")));return a},addslashes:function(a){return a.replace(ea,"\\'")},log:x&&"object"==typeof x.log?Function.prototype.call.bind(x.log,x):function(){x&&x.log.apply(x,arguments)},exception:function(a,c,b){throw{message:a,line:c,
file:b};},error:function(a,c,b){c="Error: "+a.message+" in "+(a.file||b)+" on line "+(a.line||c);a.stack&&(c+="\n"+a.stack);j.log(c);return c},keys:function(a){var c=[];Object.keys?c=Object.keys(a):j.each(a,function(a){c.push(a)});return c},each:function(a,c,b){if(a)if(a.forEach)a.forEach(c,b);else if("length"in a&&0 in a)for(var e=0,d=a.length;e<d;e++)c.call(b,a[e],e,a);else for(e in a)a.hasOwnProperty(e)&&c.call(b,a[e],e,a)},cycle:function(a,c,b){for(;a<=c;a++)b(a)},trim:M?function(a){return M.call(a)}:
function(a){return String(a).replace(Y,"").replace(Z,"")},extend:function(a){a=a||{};j.each(arguments,function(c,b){0<b&&j.each(c,function(b,c){a[c]=b})});return a},indexOf:function(a,c){if(a.indexOf)return a.indexOf(c);for(var b=0,e=a.length;b<e;b++)if(a[b]===c)return b;return-1},inherit:function(a,c,b,e){if(2===arguments.length){var d=function(){};d.prototype=c.prototype;a.prototype=new d;a.prototype.self=a;a.prototype.constructor=a;j.each(c,function(b,c){a[c]=b})}else return c.prototype[b].apply(a,
e)},defer:r,load:function(a,c,b,e){var d=j.defer();c?w.readFile(a,b||"utf-8",function(a,b){d[a?"reject":"resolve"](a||b)}):d.resolve(n("fs").readFileSync(a,b||"utf-8"));return d.done(e).promise()},mtime:function(a){return w?+Date.parse(w.lstatSync(a).mtime):0},writeFile:function(a,c,b){w&&w.writeFileSync(a,c,b)},getJSON:function(a,c,b){var e=j.defer();if(w)try{e.resolve(JSON.parse(w.readFileSync(a,c)))}catch(d){e.reject()}return e.fail(function(){b(!0)}).done(function(a){b(!1,a)}).promise()},joinObj:function(a){var c=
[];j.each(a,function(a,e){a&&c.push(e)});return c.join(" ")}};r.prototype={constructor:r};r.when=function(a){var c=r(),b=[];a instanceof r?b.push.apply(b,arguments):b=a;var e=0,d=b.length,g=function(){++e==d&&c.resolve()};j.each(b,function(a){a.done(g)});d||c.resolve();return c.promise()};void 0===Function.prototype.bind&&(Function.prototype.bind=function(a){var c=N.call(arguments,1),b=this;return function(){return b.apply(a,c.concat(N.call(arguments,0)))}});"undefined"!==typeof p?p("./utils",j):
module.exports=j;var m=n("./Node"),D=n("./utils"),l=function(a,c){this._file=c;this._opts=D.extend({tags:false,left:"<",right:">",c_open:"<\!--",c_close:"--\>",trim:true,firstLine:true},a);if(this._opts.tags)this._opts.tags=" "+this._opts.tags+" "},fa=function(a){var c=(a+"").split(""),b=0,e={};this.pos=function(){for(var a=b;a--;)if(c[a]=="\n")break;return b-a+1};this.line=function(){for(var a=1,e=b;e--;)c[e]=="\n"&&a++;return a};this.peek=function(a){return c[b+(a||0)]};this.lex=function(a){return c.slice(b,
b+a).join("")};this.match=function(a){var b=this.lex(a.length)===a;this.lastMatch=b?a:null;this.lastMatchLength=b?a.length:0;return b};this.next=function(a){if(typeof a==="string")a=a.length;b=b+(a||1);return this};this.save=function(a){e[a]=b;return this};this.load=function(a){b=e[a];return this};this.length=function(){return c.length-b};this.getStr=function(){for(var a,b="",c=this.peek(),e=1;a=this.peek();){this.next();b=b+a;if(a=="\\")e++;else{if(c==a&&!(e%2))return b.substring(1,b.length-1);e=
0}}};this.substr=function(a,e){return c.slice(a,e||b).join("")};this.extract=function(a,b){this.save("extract");b!==void 0&&this.next(b);for(var c="",e;e=this.peek();){if(this.match(a)){this.next(a);return c}c=c+e;this.next()}this.load("extract");return null}},ga=/['"]/,H=/^[\s\r\n\t]+$/,ha=/^([$a-z][\da-z\s:>]|\/\w)$/i,O=/[a-z\d:-]/i;l.prototype={constructor:l,parse:function(a){var c,b="",e=D.Array(),d,g=this._opts,f=g.tags,i=g.left,q=g.right,h=g.c_open,k=g.c_close,o=i.length,P=0;if(!g.firstLine&&
/^\s*<\?xml/.test(a)){a=D.trim(a.replace(/^[^>]+>\n?/,""));P=1}a=new fa(a);a:for(;c=a.peek();){if(a.match(h)){c=a.extract(k,a.lastMatchLength);c!==null&&e.push(m(m.COMMENT_NODE,c))}else if(a.match("<![CDATA[")){c=a.extract("]]\>",a.lastMatchLength);c!==null&&e.push(m(m.CDATA_NODE,c))}else if(a.match(i))if(ha.test(a.peek(o)+a.peek(o+1))){c=a.next(i).peek()=="/"?(a.next(),true):false;d=a;var l=f,n=q,t,p=d;t=void 0;for(var j="";t=p.peek();)if(O.test(t)){j=j+t;p.next()}else break;t=j;var j=void 0,s=p=
false,r={},u="",v=void 0;if(d.length()){d.save("attrs");l=!l||l.indexOf(" "+t+" ")>-1;c:for(;j=d.peek();)if(l&&O.test(j))for(u="";j=d.peek();)if(d.match(n)||H.test(j)){r[u]=m(u,m.ATTRIBUTE_NODE);continue c}else if(j=="="){if(ga.test(d.peek(1)))v=d.next().getStr();else{for(v="";j=d.next().peek();)if(H.test(j)||d.match(n))break;else v=v+j;v=v==""?void 0:v}r[u]=m(u,m.ATTRIBUTE_NODE,v);continue c}else{u=u+j;d.next()}else if(d.match(n)){s=true;p=d.peek(-1)=="/";d.next(n);break}else{l||(u=u+j);d.next()}if(s){d=
l?m(t,m.ELEMENT_NODE,"",r):m(t,m.ELEMENT_NODE,"",u);d.__close=p}else{d.load("attrs");d=m(m.TEXT_NODE,t)}}else d=m(m.TEXT_NODE,t);(!g.trim||!H.test(b))&&b!=""&&e.push(m(m.TEXT_NODE,b));b="";if(d.type!=m.TEXT_NODE){d.__open=!c;d.__close=d.__close||c;d.__empty=d.__open&&d.__close}e.push(d)}else{b=b+c;a.next();continue a}else{b=b+c;a.next()}a.length()==0&&b!=""&&e.push(m(m.TEXT_NODE,b));if(e.length){d=e[e.length-1];if(!d.__line){d.__line=a.line()+P;d.__file=this._file}}}return e},build:function(a){for(var c=
[],b,e,d=this.left,g=this.right;e=a.shift();){switch(e.type){case m.TEXT_NODE:case m.CDATA_NODE:b=e.value;break;case m.ELEMENT_NODE:b=d+(!e.__empty&&e.__close?"/":"")+e.name;D.each(e.attributes,function(a){b=b+(" "+a.name+(a.value!==void 0?'="'+a.value+'"':""))});b=b+((e.__empty?" /":"")+g);break;case m.CUSTOM_NODE:b=d+(e.__close?"/":"")+e.name+e.value+g}if(b!=""){c.push(b);b=""}}return c.join("")},rebuild:function(a){return this.build(this.parse(a))}};"undefined"!==typeof p?p("./Parser",l):module.exports=
l;var Q=n("./utils"),l=function(a){this._opts=a||{useWith:false}};l.prototype={constructor:l,compile:function(a){function c(){var a="",c=0,d=e.length,f,g;if(d){for(;c<d;c++){g=typeof e[c];if(f!=g||g!="string"){f&&(a=a+(f=="string"?"',":","));a=a+(g=="string"?"'":"")}a=a+(g=="string"?Q.addslashes(e[c]):e[c][0]);f=g}g=="string"&&(a=a+"'");b.push("__buf.w("+a.replace(/\r/g,"").replace(/\n/g,"\\n")+");");e=[]}}var b=[],e=[],d,g,f,i=["undef","undefined","__this=this","__XIF","__XVAL","__XFOR","__XATTR",
"__XTAG","__XBIND"];for(d="";d=a.shift();){g=d.name;if((f=d.type)&&f==d.VAR_NODE)~Q.indexOf(i,g)||i.push(g);else if(d.__break){c();b.push(d.value)}else if(g=="value"||g=="val"){c();g=d.attrAny&&d.attrAny("output");d=" try{__buf."+(g=="text"?"w":"v")+"("+d.value;g&&(d=d+(',"'+g+'"'));b.push(d+")}catch(e){__utils.error(e)} ")}else if(typeof d=="string"||f==d.TEXT_NODE||f==d.CDATA_NODE)e.push(d.value||d);else{c();b.push(d.value)}}c();if(this._opts.useWith){d="with( ctx ){ ";b.push(" } ")}else d="'use strict';/*global ctx, __buf, utils*/";
d=d+("var "+i.join(",")+"");b=";if(ctx.__part!==undef)__buf.off();"+b.join("")+" __buf.end(); return __buf.toStr();";b=d+b;n("fs").writeFileSync("out.js",b);return new Function("ctx, __buf, __utils",b)}};"undefined"!==typeof p?p("./Compiler",l):module.exports=l;var y=n("./utils"),A=function(a,c){this._data="";this._pullLen=0;this._active=true;this._stream=c;this._callback=a};A.prototype={constructor:A,uniqId:function(){return y.uniqId()},on:function(){this._active=true},off:function(){this._active=
false},v:function(a){if(this._active&&a!==void 0)this._data=this._data+y.escape(a)},w:function(a){if(this._active)this._data=this._data+a},write:function(a){if(this._active)if(arguments.length>1){var c="",b=arguments,e=b.length,d=0;switch(e){case 9:c=b[8]+c;case 8:c=b[7]+c;case 7:c=b[6]+c;case 6:c=b[5]+c;case 5:c=b[4]+c;case 4:c=b[3]+c;case 3:c=b[2]+c;case 2:this._data=this._data+(b[0]+b[1]+c);break;default:for(e=b.length;d<e;)this._data=this._data+b[d++]}}else this._data=this._data+a},cycle:function(){this._active&&
y.cycle.apply(y,arguments)},each:function(){this._active&&y.each.apply(y,arguments)},block:function(a,c,b){this.w(this.getBlock(a,c,b))},blockLabel:function(a,c,b){if(this._active){b!==void 0&&this.setBlock(a,b,true);if(this._blocks===void 0){this._chunks=[];this._blocks=[];this._attrs=[]}a=this._chunks.push(this._data,a)-1;this._blocks.push(a);c!==void 0&&(this._attrs[a]=c);this._data=""}},setBlock:function(a,c,b){if(this._block===void 0)this._block={};if(b!==true||this._block[a]===void 0)this._block[a]=
c},getBlock:function(a,c,b){this._block[a]!==void 0&&(b=this._block[a]);if(b!==void 0){a=new A;a._block=this._block;b(a,c);return a.toStr()}return""},pullSync:function(a,c,b){this.pull(a,c,b)},pull:function(a,c,b){if(this._pull===void 0)this._pull={};if(this._pull[c]===void 0){var e=y.defer(),d=function(){this._pullLen--;setTimeout(this.end.bind(this),0)}.bind(this);this._pullLen++;this._pull[c]=e.then(d,d);try{a[c](function(a,b){e[a?"reject":"resolve"](a||b)})}catch(g){e.reject(true)}}b!==void 0&&
this._pull[c].then(function(a){b(null,a)},function(a){b(a)});return this._pull[c].promise()},end:function(){if(this._stream){this._callback(this._data);this._data=""}if(this._pullLen===0){if(this._blocks!==void 0){for(var a=this._blocks,c=this._chunks,b=this._attrs,e=c.length,d=a.length,g;d--;){g=a[d];c[g]=this.getBlock(c[g],b[g])}a=c[--e];for(d=e;d--;)a=c[d]+a;this._data=a+this._data}this._callback!==void 0&&this._callback(this._data);this._stream&&this._callback(null)}},isActive:function(){return this._pullLen!==
0},toStr:function(){return this._data}};"undefined"!==typeof p?p("./Buffer",A):module.exports=A;var k=n("./utils"),I=n("./Node"),ia=n("./Parser"),ja=n("./Compiler"),ka=n("./Buffer"),h=function(a,c){this.__lego(a,c)},la=0,B={},R={},S={def:"<!DOCTYPE html>",strict:'<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">',loose:'<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">',xstrict:'<!DOCTYPE html PUBLIC  "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">',
transitional:'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">',xhtml:'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">'},ma=/^(.+)\s+as\s+(?:(.+)\s*=>\s*)?([^$]+)/i,na=/\{\*(.*?)\*\}/g;h.fn=h.prototype={self:h,constructor:h,__lego:function(a,c){if(typeof a!="string"){c=a;a=void 0}this._opts=this._defaults(c||{});this._data={};this._files={};this._listeners={};this._string=void 0;
this._filename=a},_defaults:function(a){return k.extend({ns:this.self.NS,left:this.self.LEFT,right:this.self.RIGHT,trim:this.self.TRIM,c_open:this.self.C_OPEN,c_close:this.self.C_CLOSE,rootDir:this.self.ROOT_DIR,compileDir:this.self.COMPILE_DIR,async:this.self.ASYNC,stream:this.self.STREAM,escape:this.self.ESCAPE,safeMode:this.self.SAFE_MODE,encoding:this.self.ENCODING,blockMode:this.self.BLOCK_MODE,debug:this.self.DEBUG},a)},_compile:function(a,c){if(this._tpl===void 0){var b=k.defer().done(c),e=
{};this._load(a,function(c){if(c){this._tpl=c;b.resolve(this._tpl)}else{if(!this._compiler)this._compiler=new ja(this._opts);this._parse(this._opts.rootDir+a,e,function(c){this._tpl=this._compiler.compile(c);this._save(a,e);b.resolve(this._tpl)}.bind(this))}}.bind(this))}else c(this._tpl)},_parse:function(a,c,b,e){if(this._parser===void 0)this._parser=new ia(this._opts,a);var d=this._opts,g=k.defer(),f=function(b){for(var d=[],f=a.replace(/\/[\s%|\w\._-]+$/,"/"),h,j,l=0,b=this._parser.parse(b);h=
b[l];){j=h.name;(j=="include"||j=="extends")&&d.push(this._parse(f+h.attrAny("src file",true),c,0,1).done(function(a,c){b.splice(a,1);b.addMulti(c,a)}.bind(this,l)));l++}k.defer.when(d).done(function(){g.resolve(e?b:this._processing(b))}.bind(this))}.bind(this);if(this._string!==void 0)f(this._string);else{c[a]||(c[a]=k.mtime(a));k.load(a,d.async,d.encoding,f)}return g.done(b).promise()},_processing:function(a){for(var c=0,b,e=[],d;c in a;){this._pre(b=a[c],c,a);c++}try{for(;b=a.shift();){this._prepare(b,
a,e);b.prev=this.__node;d=this._trans(b,a,e);this.__node=b;d!==null&&b.type!=b.COMMENT_NODE&&e.push(d)}}catch(g){e=[k.error(g)]}this.__node=void 0;return this._normalizeStack(e)},_normalizeStack:function(a){for(var c=[],b;b=a.shift();)typeof b!="string"&&b[0]?a=b.concat(a):c.push(b);return c},_save:function(a,c){this._opts.compileDir&&k.writeFile(this._opts.compileDir+a+".json",JSON.stringify({includes:c,template:this._tpl.toString()}),this._opts.encoding)},_load:function(a,c){var b=this._opts,e=
true,d=k.defer();b.compileDir?k.getJSON(b.compileDir+a+".json",b.encoding,function(a,b){if(a)d.resolve(false);else{k.each(b.includes,function(a,b){k.mtime(b)!=a&&(e=false)});d.resolve(e&&(new Function("return "+b.template))())}}):d.resolve(false);return d.done(c).promise()},_try:function(a,c,b){if(!c)if(a&&a.__line){c=a;a=a.value}else c={};return"try{"+a+"}catch(_){"+(this._opts.debug&&c.__line?"__utils.error(_,"+c.__line+',"'+c.__file+'");':"")+(b!==void 0?"return "+b:"")+"}"},_pre:function(a,c,
b){function e(b){return a.c.apply(a,[d].concat(b))}var d=this._opts.ns,g,f=a.attributes,i=I.findClosureIdx(b,a,c),h=k.Array(),j=k.Array(),l=k.Array(),m=k.Array();switch(a.name){case "tag":!a.__close&&(R[a.attr("name")]=1)}typeof f!="string"&&k.each(f,function(e,f){if(d&&e.ns==d){a.removeAttr(f);g=e.value;f=e.name;switch(f){case "if":case "tag-if":var k=["if",{test:g}],n=["if",0,1];if(f=="if"){h.addOrder(k,0);m.addOrder(n,5)}else{h.addOrder(k,3);j.addOrder(n,2);l.addOrder(["if",{test:g}],3);m.addOrder(["if",
0,1],2)}break;case "val":case "value":j.addOrder(["val"],6).addOrder(["<text>",0,0,g],7).addOrder(["val",0,1],8);if(a.__empty){a.__empty=a.__close=0;b.add(a.clone("",a.name,a.type,0,1),c+1)}break;case "set":h.addOrder(["set",{name:g}],1);m.addOrder(["set",0,1],4);break;case "get":j.addOrder(["get",{name:g}],3);if(a.__empty){i=c+1;a.__empty=a.__close=0;b.add(a.clone("",a.name,a.type,0,1),i)}l.addOrder(["get",0,1],1);break;case "foreach":case "inner-foreach":g=g.match(ma);var k={iterate:g[1]},n=["foreach",
k],o=["foreach",0,1];if(g[2])k.index=g[2];k.as=g[3];if(f=="foreach"){h.addOrder(n,2);m.addOrder(o,3)}else{j.addOrder(n,5);l.addOrder(o,0)}break;case "class":a.addAttr("class","{*__utils.joinObj("+g+")*}")}}},this);b.addMulti(m.order().map(e),i+1);b.addMulti(l.order().map(e),i);b.addMulti(j.order().map(e),c+1);b.addMulti(h.order().map(e),c)},_prepare:function(a,c){var b=c[0],e=b&&b.name;if(b&&(e=="attrs"||e=="attributes"))a.__openTag=true},_trans:function(a,c){var b,e=[],d=a.name,g=a.value,f=a.attributes;
if(this._opts.ns==a.ns||!a.ns)switch(d){case "script":b=" "+this._try(c.shift().value,a)+" ";c.shift();break;case "if":b=a.__close?"}":"__XIF=false;"+this._try("__XIF=("+g+")",a)+"if(__XIF){";break;case "else":b="}"+d+"{";break;case "elseif":case "else if":b="}else if("+this.safe(g,a)+"){";break;case "for":case "cycle":case "foreach":a.__break=true;if(a.__close)b="});";else{d="";if(f.to)b="__buf.cycle("+a.attr("from")+", "+a.attr("to")+", function ("+(f.key||f.item||{value:""}).value+"){";else{if(f.item)d=
f.item.value;f.key&&(d=d+((d==""?"__v,":",")+f.key.value));b="__XFOR=0;"+this._try("__XFOR="+a.attr("from",f._from),a)+"__buf.each(__XFOR, function ("+d+"){"}}break;case "pull":if(a.__close)b="__buf.w('</span>');";else{var i={id:k.uniqId(),name:a.attr("name"),as:f.as&&a.attr("value")||a.attr("name"),async:!!f.async,error:f.error&&a.attr("error")||"err"};if(!this._pullStack)this._pullStack=[];this._pullStack.push(i);b="__buf.w('<span id=\""+i.id+"\">');";if(f.async)b=b+('__buf.pull(ctx,"'+i.name+'");');
else{b=b+('__buf.pullSync(ctx,"'+i.name+'",function('+i.error+","+i.as+"){");c.push({value:"});",type:a.ELEMENT_NODE})}}break;case "assign":d=a.attr("name").split(".");i=d.shift();f=f.type&&f.type.value||"string";b="";if(i=="ctx")b='__utils.ns(ctx,"'+d.join(".")+'",';else{f!="var"?c.push(I(i,I.VAR_NODE)):b="var "+i+";";if(d.length>0){b=b+("if("+i+"===undef)"+i+"={};");b=b+("__utils.ns("+i+',"'+d.join(".")+'",')}else b=b+(i+"=(")}b=f!="string"?b+a.attr("value"):b+("'"+k.addslashes(a.attr("value"))+
"'");b=b+");";break;case "get":var d=[],h;if(f.attrs)h=f.attrs.value;else for(i in f)i!="name"&&i!="attrs-name"&&d.push(this._try("a."+i+"="+a.attr(i),a));if(a.__empty)b='__buf.#method#("'+a.attr("name")+'",#attrs#);';else if(a.__close)b="});";else if(this._opts.blockMode==1)b='__buf.#method#("'+a.attr("name")+'",#attrs#,function (__buf,'+(f["attrs-name"]&&f["attrs-name"].value||"attrs")+"){";else{b='__buf.#method#("'+a.attr("name")+'",#attrs#);';h=c.shift().value;c.shift()}if(h){d.length&&console.log("WARNING: Can't use block attributes at block mode == 2");
b='__XATTR="";'+this._try("__XATTR="+h,a)+b;d="__XATTR"}else d=d.length?"(function(a){"+d.join("")+" return a})({})":"undef";b=b.replace("#attrs#",d).replace("#method#",this._opts.stream||this.blockLevel?"block":"blockLabel");break;case "set":if(c[0].name=="set"&&c[0].__close){c.shift();return null}this.blockLevel=(this.blockLevel|0)+(a.__close?-1:1);if(a.__close)b="});";else{b="";f.test&&(b=b+("if("+this.safe(a.attr("test"),a)+")"));b=b+('__buf.setBlock("'+a.attr("name")+'",function(__buf,'+(f["attrs-name"]&&
a.attr("attrs-name")||"attrs")+"){")}break;case "fail":case "loading":case "success":i=this._pullStack[this._pullStack.length-1];if(d=="loading")return null;b=a.__close?"}":"if("+(d=="fail"?"":"!")+i.error+"){";i.async&&(b=a.__close?b+('__buf.w(\'</span><script>(function(a,b){try{a.parentNode.insertBefore(b,a);b.style.display="";a.parentNode.removeChild(a);}catch(er){}})(__utils.$("#%id"),__utils.$("#%name%id"));<\/script>'.replace(/%id/g,i.id).replace("%name",a.name)+"'); });"):'__buf.pull(ctx,"'+
i.name+'",function('+i.error+","+i.as+"){__buf.w('<span id=\""+d+i.id+'" style="display: none">\');'+b);break;case "part":if(a.__close)b='if(ctx.__part=="'+this.__parts.pop()+'")__buf.off();';else{b='if(ctx.__part=="'+a.attr("name")+'")__buf.on();';if(!this.__parts)this.__parts=[];this.__parts.push(a.attr("name"))}break;case "space":a.type=a.TEXT_NODE;b=" ";break;case "text":a.type=a.TEXT_NODE;if(a.__empty)b=a.attr("value");else{b=c.shift().value;c.shift()}break;case "attrs":case "attributes":if(a.__close){b=
"";a.type=a.TEXT_NODE;if(c[0].__close&&!c[0].__empty&&c[0].isShort()){c.shift();b=b+"/"}b=b+this._opts.right}else{(!a.prev||a.prev.type!=a.ELEMENT_NODE||a.prev.__close)&&k.exception("<"+this._opts.ns+":"+d+"/> must be the first child",a.__line,a.__file);return null}break;case "attr":case "attribute":a.type=a.TEXT_NODE;b=a.__close?'"':" "+a.attr("name")+'="';break;case "closure":if(a.__close)b="})("+this.__closure.shift().join(",")+");";else{d=[];h=[];b="(function(";this.__closure=this.__closure||
[];for(i in f){h.push(i);d.push(this.safe(a.attr(i),a))}b=b+(h.join(",")+"){");this.__closure.push(d)}break;case "tag":b=a.__close?"}":"function __xtag_"+a.attr("name").replace(/-/g,"_")+"(__buf,"+(f.context&&f.context.value||"tag")+",__inner){";break;case "tag-inner":b="if(__inner!==undef)__inner();";break;case "bind":f=this.__bind;if(a.__close)b="} "+f.n+".id=__XBIND; function _"+f.n+'(){console.time("'+f.d+'");var buf=new __buf.constructor,node=document.getElementById('+f.n+".id);if(node){"+f.n+
"("+f.d+".toJSON(),buf);node.innerHTML=buf.toStr();}else{"+f.d+'.off("all", __'+f.n+')}console.timeEnd("'+f.d+'");}function __'+f.n+"(){clearTimeout("+f.n+".pid);"+f.n+".pid=setTimeout(_"+f.n+","+f.m+");} "+f.d+'.on("all", __'+f.n+");";else{this.__bind=f={n:"__xbind_"+ ++la,d:a.attr("data"),a:a.attr("as"),m:a.attrAny("delay")||30,t:a.attrAny("tag")||"div"};b="__XBIND=__buf.uniqId();__buf.w('<"+f.t+" id=\"'+__XBIND+'\">');"+f.n+"("+f.d+'.toJSON(),__buf);__buf.w("</'+f.t+'>");function '+f.n+"("+f.a+
",__buf){"}break;default:if(d in R)if(!a.__empty&&a.__close)b="});";else{b="__XTAG={};";f.context?b=b+this._try("__XTAG="+f.context.value,a):k.each(f,function(c,d){d='__XTAG["'+d+'"]';b=b+(d+'="'+c.value.replace(na,function(b,c){return'";'+this._try(d+"+="+c,a)+d+'+="'}.bind(this))+'";')},this);b=b+("__xtag_"+d.replace(/-/g,"_")+"(__buf,__XTAG"+(a.__empty?");":",function(){"))}else{b=this._myNode(d,a,f);if(b!==void 0){a.type=a.TEXT_NODE;if(k.isArray(b)){e=b;b=void 0}}}}if(b!==void 0)a.value=b;return e.length?
e:a},_myNode:function(a,c,b){if(B[a])return B[a].call(this,c,b);if(B._)return B._.call(this,c,b)},compile:function(a){a=a||function(){};this._tpl===void 0?this._compile(this._filename,a):a(this._tpl);return this._tpl},fetch:function(a,c){if(c===void 0){c=a;a=void 0}if(this._tpl===void 0)this._compile(this._filename,this.fetch.bind(this,a,c));else{this._tpl.prototype.fns=this.fns;this._tpl.prototype.mods=this.mods;new this._tpl(a||{},new ka(c,this._opts.stream),k)}},loadString:function(a){this._string=
k.trim(a);this._compile();return this},on:function(a,c){this._listeners[a]=c;return this},set:function(a,c){typeof a=="string"?this._data[a]=c:this._data=a||{};return this},safe:function(a,c,b){if(!c||!c.__line){b=c;c=void 0}return this._opts.safeMode?"(function(){"+this._try("return "+a,c,'""')+"})"+(b?"":"()"):a},escape:function(a,c){return this._opts.escape?"__utils.escape("+this.safe(a,c)+")":this.safe(a,c)}};h.NS="xtpl";h.LEFT="<";h.RIGHT=">";h.C_OPEN="<\!--";h.C_CLOSE="--\>";h.TRIM=!0;h.ASYNC=
!0;h.STREAM=!1;h.ESCAPE=!0;h.SAFE_MODE=!0;h.ENCODING="utf-8";h.BLOCK_MODE=1;h.DEBUG=!0;h.ROOT_DIR="";h.COMPILE_DIR="";h.fetch=function(a,c,b){var e=new h(a),d=k.defer(),g="";e.fetch(c,function(a){a===null||!e._opts.stream?d.resolve(e._opts.stream?g:a):g=g+a});b&&d.done(b);return d.promise()};h.compile=function(a){return(new h(a,{async:false})).compile()};h.fromString=function(a,c){return(new h(c)).loadString(a)};h.tags=function(a){k.each(a,function(a,b){B[b]=a});return this};h.tags({doctype:function(a,
c){return S[c.mode&&c.mode.value]||S.def}});h.engine=function(a){typeof a=="string"&&(a=n("./"+a));var c=this.fn;c._super={};k.each(a.statics,function(a,c){this[c]=a},this);k.each(a.fn,function(a,e){var d=c[e];d&&(c._super[e]=d);c[e]=a});return h};h.mods=function(a){k.extend(k.mods,a)};"undefined"!==typeof p?p("./AsyncTpl",h):module.exports=h;var E=n("./utils"),l={},oa=/\{\*|\*\}/g;l.fn={_defaults:function(a){return this._super._defaults.call(this,E.extend(a||{},{firstLine:false}))},_build:function(a,
c){var b=[];typeof a=="string"&&(a={name:"a"});if(!a.__empty&&a.__close)b.push("</"+a.name+">");else{b.push("<"+a.name);E.each(c,function(a){b.push(" "+a.name+'="');for(var a=a.value.split(oa),c=0,g=a.length,f;c<g;c++){f=a[c];c%2?b.push({name:"value",value:f,__escape:true}):f!==""&&b.push(f)}b.push('"')},this);a.__openTag||b.push(a.__empty?"/>":">")}return b},_trans:function(a,c,b){var e=[],d,g=a.attributes;if(a.ns!=this._opts.ns)a.type==a.ELEMENT_NODE&&(e=this._build(a,g));else switch(a.name){case "if":d=
a.__close?"":a.attr("test");break;case "choose":this.__choose=a.__open?1:0;break;case "when":d=a.__close?"}":(this.__choose==1?"":" else ")+"if("+this.safe(a.attr("test"),a)+"){";this.__choose++;break;case "otherwise":d=a.__close?"}":" else {";break;case "foreach":g={_from:"iterate",from:g.iterate||g.from,key:g.index,item:g.as,to:g.to};break;case "val":case "value":d=E.trim(c.shift().value).replace(/;$/,"");c.shift();g.mod&&(d='__utils.mods["'+a.attr("mod")+'"]('+d+")");break;case "comment":d="<\!--"+
c.shift().value+"--\>";c.shift();a.type=a.TEXT_NODE;break;case "template":return null}if(d!==void 0)E.isArray(d)?e=d:a.value=d;a.attributes=g;return e.length?e:this._super._trans.call(this,a,c,b)}};"undefined"!==typeof p?p("./XML",l):module.exports=l;l=n("AsyncTpl");l.get=n;T.AsyncTpl=l;var C={},J=n("utils");AsyncTpl.fetch=function(a,c,b,e){if(typeof c!="string"){e=b;b=c;c=F}if(C[a]===F)if(a.charAt(0)=="#"){var d=J.$(a)||{innerHTML:"[[#"+a+" \u2014 not found]]"};C[a]=new this;C[a].loadString(d.innerHTML)}else C[a]=
new this(a);var g=J.defer();C[a].fetch(b,function(a){g.resolve(a===F?"":a)});c&&g.done(function(a){var b=J.$(c);if(b)b.innerHTML=a});return g.promise().done(e)};"undefined"!=typeof jQuery&&(jQuery.xtpl=function(a){AsyncTpl.engine(a);jQuery.xtpl=function(){return this};return this},jQuery.fn.xtpl=function(a,c){jQuery.xtpl("XML").fetch(a,this[0],c);return this})})(this);
