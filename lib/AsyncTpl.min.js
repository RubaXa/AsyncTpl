(function(C,w){function o(b,j){A[b.replace(B,"")]=j}function p(b){return A[b.replace(B,"")]}var B=/^.+\//,A={};o("fs",{readFile:function(b,j,m){jQuery.ajax({url:b,type:"get",dataType:"text",isLocal:!0,success:function(b){m(null,b)}})},readFileSync:function(b){return jQuery.ajax({url:b,type:"get",async:!1,dataType:"text",isLocal:!0}).responseText},lstatSync:function(){return{mtime:0}}});(function(){function b(d,f,i,a){if(!(this instanceof b))return new b(d,f,i,a);if("number"===typeof d)switch(a=i,
i=f,f=d,f){case b.TEXT_NODE:d="<text>";break;case b.CDATA_NODE:d="<cdata>";break;case b.COMMENT_NODE:d="<comment>";break;case b.CUSTOM_NODE:d="<custom>"}else if(d=d.toLowerCase(),d.match(j))this.ns=RegExp.$1,d=RegExp.$2;this.name=d;this.type=f;this.value=i;this.attributes=a||[];this.childNodes=[]}var j=/(\w+):(\w+)/,m={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_NODE:4,COMMENT_NODE:8,CUSTOM_NODE:20,COMPILER_NODE:21};b.prototype={constructor:b,replace:function(b){this.name=b.name;this.type=b.type;
this.value=b.value;this.attributes=b.attributes;return this},addTextNode:function(d){return this.addChild(b.TEXT_NODE,d)},addChild:function(d,f,i,a){d instanceof b||(d=b(d,f,i,a));this.childNodes.push(d);return this},addChilds:function(b){this.childNodes.push.apply(this.childNodes,b);return this},hasChildNodes:function(){return!!this.childNodes.length}};for(var f in m)b[f]=b.prototype[f]=m[f];"undefined"!==typeof o?o("./Node",b):module.exports=b})();(function(b,j){function m(a){if(!(this instanceof
m))return new m(a);var b=[],c=[],e,g,h=!0,n=!0,d=!1;this.done=function(a){h&&a!==j&&(d?a(g):b.push(a));return this}.bind(this);this.fail=function(a){n&&a!==j&&(d?a(g):c.push(a));return this}.bind(this);this.then=function(a,D){return this.done(a).fail(D)}.bind(this);this.reject=function(a){h=!1;d=!0;for(g=a;c.length;)c.shift()(a);return this}.bind(this);this.resolve=function(a){n=!1;d=!0;for(g=a;b.length;)b.shift()(a);return this}.bind(this);this.promise=function(){e===j&&(e={done:this.done,fail:this.fail,
then:this.then,promise:this.promise});return e}.bind(this);a!==j&&a(this)}var f=String.prototype.trim,d=/^#/,k=[].slice,i=/^\s+/,a=/\s+$/,h=/[&<>"]/,e=/[&<>"]/g,g=/'/g,c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},n={$:function(a){return"string"==typeof a?document.getElementById(a.replace(d,"")):a},sizeof:function(a){var b=0,c;if(a&&("object"==typeof a||"object"==typeof a))if("length"in a)b=a.length;else for(c in a)b++;return b},uniqId:function(){return(new Date).getTime()+""+Math.round(1E3*
Math.random())},escape:function(a){return"string"===typeof a&&h.test(a)?a.replace(e,function(a){return c[a]}):a},addslashes:function(a){return a.replace(g,"\\'")},keys:function(a){var b=[];Object.keys?b=Object.keys(a):n.each(a,function(a){b.push(a)});return b},each:function(a,b,c){if(a)if(a.forEach)a.forEach(b,c);else if("length"in a&&0 in a)for(var e=0,g=a.length;e<g;e++)e in a&&b.call(c,a[e],e,a);else for(e in a)a.hasOwnProperty(e)&&b.call(c,a[e],e,a)},cycle:function(a,b,c){for(;a<b;a++)c()},trim:f?
function(a){return f.call(a)}:function(b){return(""+b).replace(i,"").replace(a,"")},extend:function(a){a=a||{};this.each(arguments,function(b,c){0<c&&this.each(b,function(b,c){a[c]=b})},this);return a},indexOf:function(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0,e=a.length;c<e;c++)if(a[c]===b)return c;return-1},inherit:function(a,b,c,e){if(2===arguments.length){var g=function(){};g.prototype=b.prototype;a.prototype=new g;a.prototype.self=a;a.prototype.constructor=a;n.each(b,function(b,c){a[c]=
b})}else return b.prototype[c].apply(a,e)},defer:m,load:function(a,c,e,g){var h=this.defer();c?b.readFile(a,e||"utf-8",function(a,b){h[a?"reject":"resolve"](a||b)}):h.resolve(p("fs").readFileSync(a,e||"utf-8"));return h.done(g).promise()},mtime:function(a){return b?+Date.parse(b.lstatSync(a).mtime):0},writeFile:function(a,c,e){b&&b.writeFileSync(a,c,e)},getJSON:function(a,c,e){var g=n.defer();if(b)try{g.resolve(JSON.parse(b.readFileSync(a,c)))}catch(h){g.reject()}return g.fail(function(){e(!0)}).done(function(a){e(!1,
a)}).promise()}};m.prototype={constructor:m};m.when=function(a){var b=m(),c=[];a instanceof m?c.push.apply(c,arguments):c=a;var e=0,g=c.length,h=function(){++e==g&&b.resolve()};n.each(c,function(a){a.done(h)});g||b.resolve();return b.promise()};if(Function.prototype.bind===j)Function.prototype.bind=function(a){var b=k.call(arguments,1),c=this;return function(){return c.apply(a,b.concat(k.call(arguments,0)))}};"undefined"!==typeof o?o("./utils",n):module.exports=n})(p("fs"));(function(b,j,m){function f(a){this._opts=
j.extend({tags:!1,left:"<",right:">",c_open:"<\!--",c_close:"--\>",trim:!0,firstLine:!0},a);if(this._opts.tags)this._opts.tags=" "+this._opts.tags+" "}function d(a){var b=(a+"").split(""),c=0,h={};this.peek=function(a){return b[c+(a||0)]};this.lex=function(a){return b.slice(c,c+a).join("")};this.match=function(a){var b=this.lex(a.length)===a;this.lastMatch=b?a:null;this.lastMatchLength=b?a.length:0;return b};this.next=function(a){if("string"===typeof a)a=a.length;c+=a||1;return this};this.save=function(a){h[a]=
c;return this};this.load=function(a){c=h[a];return this};this.length=function(){return b.length-c};this.getStr=function(){for(var a,b="",c=this.peek(),e=1;a=this.peek();)if(this.next(),b+=a,"\\"==a)e++;else{if(c==a&&!(e%2))return b.substring(1,b.length-1);e=0}};this.extract=function(a,b){this.save("extract");b!==m&&this.next(b);for(var c="",e;e=this.peek();){if(this.match(a))return this.next(a),c;c+=e;this.next()}this.load("extract");return null}}var k=/['"]/,i=/^[\s\r\n\t]+$/,a=/^([$a-z][a-z\s:>]|\/\w)$/i,
h=/[a-z\d:]/i;f.prototype={constructor:f,parse:function(e){var g,c="",n=[],f=this._opts,E=f.tags,z=f.left,F=f.right,G=f.c_open,o=f.c_close,p=z.length;!f.firstLine&&/^\s*<\?xml/.test(e)&&(e=j.trim(e.replace(/^[^\n]+\n/,"")));e=new d(e);a:for(;g=e.peek();){if(e.match(G))g=e.extract(o,e.lastMatchLength),null!==g&&n.push(b(b.COMMENT_NODE,g));else if(e.match("<![CDATA["))g=e.extract("]]\>",e.lastMatchLength),null!==g&&n.push(b(b.CDATA_NODE,g));else if(e.match(z))if(a.test(e.peek(p)+e.peek(p+1))){g="/"==
e.next(z).peek()?(e.next(),!0):!1;var l;l=e;var x=E,t=F,r,y=l;r=void 0;for(var q="";r=y.peek();)if(h.test(r))q+=r,y.next();else break;r=q;var q=void 0,w=y=!1,v={},s="",u=void 0;if(l.length()){l.save("attrs");x=!x||-1<x.indexOf(" "+r+" ");c:for(;q=l.peek();)if(x&&h.test(q))for(s="";q=l.peek();)if(l.match(t)||i.test(q)){v[s]={name:s,value:m};continue c}else if("="==q){if(k.test(l.peek(1)))u=l.next().getStr();else{for(u="";(q=l.next().peek())&&!i.test(q)&&!l.match(t);)u+=q;u=""==u?m:u}v[s]=b(s,b.ATTRIBUTE_NODE,
u);continue c}else s+=q,l.next();else if(l.match(t)){w=!0;y="/"==l.peek(-1);l.next(t);break}else x||(s+=q),l.next();w?(l=x?b(r,b.ELEMENT_NODE,"",v):b(r,b.ELEMENT_NODE,"",s),l.__close=y):(l.load("attrs"),l=b(b.TEXT_NODE,r))}else l=b(b.TEXT_NODE,r);f.trim&&i.test(c)||""!=c&&n.push(b(b.TEXT_NODE,c));c="";if(l.type!=b.TEXT_NODE)l.__open=!g,l.__close=l.__close||g,l.__empty=l.__open&&l.__close;n.push(l)}else{c+=g;e.next();continue a}else c+=g,e.next();0==e.length()&&""!=c&&n.push(b(b.TEXT_NODE,c))}return n},
build:function(a){for(var g=[],c,h,f=this.left,d=this.right;h=a.shift();){switch(h.type){case b.TEXT_NODE:case b.CDATA_NODE:c=h.value;break;case b.ELEMENT_NODE:c=f+(!h.__empty&&h.__close?"/":"")+h.name;j.each(h.attributes,function(a){c+=" "+a.name+(a.value!==m?'="'+a.value+'"':"")});c+=(h.__empty?" /":"")+d;break;case b.CUSTOM_NODE:c=f+(h.__close?"/":"")+h.name+h.value+d}""!=c&&(g.push(c),c="")}return g.join("")},rebuild:function(a){return this.build(this.parse(a))}};"undefined"!==typeof o?o("./Parser",
f):module.exports=f})(p("./Node"),p("./utils"));(function(b){function j(b){this._opts=b||{useWith:!1}}j.prototype={constructor:j,compile:function(j){function f(){var a="",h=0,e=k.length,g,c;if(e){for(;h<e;h++){c=typeof k[h];if(c!=g||"string"!=c)g&&("string"==g&&(a+="'"),a+=", "),"string"==c&&(a+="'");a+="string"==c?b.addslashes(k[h]):k[h][0];g=c}"string"==c&&(a+="'");d.push("__ondata("+a.replace(/\r/g,"").replace(/\n/g,"\\n")+");");k=[]}}for(var d=[""],k=[],i;i=j.shift();)i.__break?(f(),d.push(i.value)):
"value"==i.name?k.push([i.value]):"string"==typeof i||i.type==i.TEXT_NODE||i.type==i.CDATA_NODE?k.push(i.value||i):(f(),d.push(i.value));f();this._opts.useWith?(d[0]="with( ctx ){ ",d.push(" } ")):d[0]="'use strict';";return new Function("ctx, __this, __ondata, __utils",d.join("")+" __ondata();")}};"undefined"!==typeof o?o("./Compiler",j):module.exports=j})(p("./utils"));(function(b,j,m,f){function d(a,b){this.__lego(a,b)}var k={},i=(new Date).getTime()+Math.round(1E4*Math.random());d.prototype={self:d,
constructor:d,__lego:function(a,b){"string"!=typeof a&&(b=a,a=f);this._opts=this._defaults(b||{});this._data={};this._files={};this._listeners={};this._string=f;this._filename=a;this._pullLen=0;this._pullQueue={};this.blockLabel="[["+i+"]]"},_defaults:function(a){return b.extend({left:this.self.LEFT,right:this.self.RIGHT,trim:this.self.TRIM,c_open:this.self.C_OPEN,c_close:this.self.C_CLOSE,rootDir:this.self.ROOT_DIR,compileDir:this.self.COMPILE_DIR,async:this.self.ASYNC,stream:this.self.STREAM,escape:this.self.ESCAPE,
safeMode:this.self.SAFEMODE,encoding:this.self.ENCODING},a)},_fetch:function(){this._compile(this._filename,function(a){function h(){var a=arguments.length-1,b=arguments[a]+"",h=arguments[0];if(h===e)k(),k(),j.push(g,arguments[1]),k(),this.setBlock(arguments[1],arguments[2]);else if(h===f)c&&k();else{if(0!==a)for(;a--;)b=arguments[a]+b;k(b)}}this.emit("start");var e=this.blockLabel,g=0,c=!this._opts.stream,d="",i=[],j=[],k=this._opts.stream&&this._listeners.data||function(a){a===f?(i[g++]=d,d=""):
d+=a};this._blocks={};this._resultFn=function(){""!==d&&h();if(c){for(var a="",b=j.length-1;0<=b;b-=2)i[j[b-1]]=this.getBlock(j[b]);for(b=i.length;b--;)a=i[b]+a;return a}};a(this._data,this,h.bind(this),b);this._end()}.bind(this));return this},_uniqKey:function(a){var b=this._opts;return b.LEFT+b.RIGHT+b.TRIM+b.stream+a},_compile:function(a,h){var e=this._uniqKey(a);if(this._tpl)h(this._tpl);else if(a===f||k[e]===f){var g=b.defer(),c={};this._load(a,function(b){if(b)g.resolve(b);else{if(!this._compiler)this._compiler=
new m(this._opts);this._parse(this._opts.rootDir+a,c,function(b){b=this._tpl=this._compiler.compile(b);this._save(a,c);g.resolve(b)}.bind(this),c)}}.bind(this));k[e]=g}k[e].done(h)},_parse:function(a,h,e){if(this._parser===f)this._parser=new j(this._opts);var g=this._opts,c=b.defer(),d=[],i=function(e){for(var g=[],f,i=a.replace(/\/[\s%|\w\._-]+$/,"/"),j,e=this._parser.parse(e);f=e.shift();)j=this._trans(f,e),null!==j&&f.type!=f.COMMENT_NODE&&d.push(j),"include"==f.name&&g.push(this._parse(i+f.value,
h).done(function(a,b){d[a-1]=b}.bind(this,d.length)));b.defer.when(g).done(function(){c.resolve(this._normalizeStack(d))}.bind(this))}.bind(this);this._string!==f?i(this._string||"[[undefined]]"):(h[a]||(h[a]=b.mtime(a)),this.self.load(a,g.async,g.encoding,i));return c.done(e).promise()},_normalizeStack:function(a){for(var b=[],e;e=a.shift();)"string"!=typeof e&&e[0]?a=e.concat(a):b.push(e);return b},_save:function(a,h){this._opts.compileDir&&b.writeFile(this._opts.compileDir+a+".json",JSON.stringify({includes:h,
template:this._tpl.toString()}),this._opts.encoding)},_load:function(a,h){var e=this._opts,g=!0,c=b.defer();e.compileDir?b.getJSON(e.compileDir+a+".json",e.encoding,function(a,e){a?c.resolve(!1):(b.each(e.includes,function(a,c){b.mtime(c)!=a&&(g=!1)}),c.resolve(g&&(new Function("return "+e.template))()))}):c.resolve(!1);return c.done(h).promise()},_end:function(){this._pullLen||this.emit("end",this._resultFn())},_trans:function(a,h){var e=[],g,c=a.attributes;if(this._opts.ns==a.ns||!a.ns)switch(a.name){case "doctype":g=
"<!DOCTYPE html>";a.type=a.TEXT_NODE;break;case "script":g=" try{ "+h.shift().value+" } catch(e){} ";h.shift();break;case "if":g=a.__close?"}":"if("+this.safe(a.value)+"){";break;case "else":g="}"+a.name+"{";break;case "elseif":case "else if":g="}else if("+this.safe(a.value)+"){";break;case "cycle":case "foreach":a.__break=!0;if(a.__close)a.value="});";else{var d="";if("cycle"==a.name)a.value="__utils.cycle("+c.from.value+", "+c.to.value+", function (){";else{if(c.item)d=c.item.value;c.key&&(d+=(""==
d?"__v,":",")+c.key.value);a.value="__utils.each("+this.safe(c.from.value)+", function ("+d+"){"}}break;case "pull":if(a.__close)g="__ondata('</span>');";else{d={id:b.uniqId(),name:c.name.value,as:c.as&&c.as.value||c.name.value,async:!!c.async,error:c.error&&c.error.value||"err"};if(!this._pullStack)this._pullStack=[];this._pullStack.push(d);g="__ondata('<span id=\""+d.id+"\">');";c.async?g+='__this.pull(ctx,"'+c.name.value+'");':(g+='__this.pullSync(ctx,"'+d.name+'",function('+d.error+","+d.as+"){",
h.push({value:"});",type:a.ELEMENT_NODE}))}break;case "get":this._opts.stream||this.blockLevel?(a.name="value",a.__empty?g='__this.getBlock("'+c.name.value+'")':(g=a.__close?"}));":'__ondata(__this.getBlock("'+c.name.value+'", function (__ondata){',a.__break=!0)):g=a.__empty?'__ondata(__this.blockLabel, "'+c.name.value+'");':a.__close?"});":'__ondata(__this.blockLabel, "'+c.name.value+'", function (__ondata){';break;case "set":this.blockLevel=(this.blockLevel>>0)+(a.__close?-1:1);g=a.__close?"});":
(c.test?"if("+this.safe(c.test.value)+")":"")+'__this.setBlock("'+c.name.value+'",function(__ondata){';break;case "fail":case "loading":case "success":d=this._pullStack[this._pullStack.length-1];if("loading"==a.name)return null;g=a.__close?"}":"if("+("fail"==a.name?"":"!")+d.error+"){";d.async&&(g=a.__close?g+('__ondata(\'</span><script>(function(a,b){try{a.parentNode.insertBefore(b,a);b.style.display="";a.parentNode.removeChild(a);}catch(er){}})(__utils.$("#%id"),__utils.$("#%name%id"));<\/script>'.replace(/%id/g,
d.id).replace("%name",a.name)+"'); });"):'__this.pull(ctx,"'+d.name+'",function('+d.error+","+d.as+"){__ondata('<span id=\""+a.name+d.id+'" style="display: none">\');'+g)}if(g!==f)a.value=g;return e.length?e:a},clone:function(){var a=new this.self(this._filename,this._opts);a._tpl=this._tpl;a._string=this._string;a._filename=this._filename;b.each(this._data,function(b,e){a._data[e]=b});b.each(this._listeners,function(b,e){a._listeners[e]=b});return a},loadString:function(a){this._string=b.trim(a);
return this},emit:function(a,b){var e=this._listeners;if(e[a]!==f)e[a](b)},on:function(a,b){this._listeners[a]=b;return this},set:function(a){this._data=a;return this},getBlock:function(a,b){var e="";this._blocks[a]!==f&&(b=this._blocks[a]);b!==f&&b(function(){var a=arguments.length-1,b=arguments[a];if(0!==a)for(;a--;)b=arguments[a]+b;e+=b});return e},setBlock:function(a,b){b!==f&&(this._blocks[a]=b)},pullSync:function(a,b,e){this.pull(a,b,e)},pull:function(a,d,e){if(this._pullQueue[d]===f){var g=
b.defer(),c=function(){this._pullLen--;setTimeout(this._end.bind(this),0)}.bind(this);this._pullLen++;this._pullQueue[d]=g.then(c,c);try{a[d](function(a,b){g[a?"reject":"resolve"](a||b)})}catch(i){g.reject(!0)}}e!==f&&this._pullQueue[d].then(function(a){e(null,a)},function(a){e(a)});return this._pullQueue[d].promise()},fetch:function(){return this.clone()._fetch()},safe:function(a){return this._opts.safeMode?"(function(){try{return "+a+'}catch(e){return""}})()':a},escape:function(a){return this._opts.escape?
"__utils.escape("+this.safe(a)+")":a}};d._files={};d.load=function(a,d,e,g){return(this._files[a]||(this._files[a]=b.load(a,d,e))).done(g)};d.NS="xtpl";d.LEFT="<";d.RIGHT=">";d.C_OPEN="<\!--";d.C_CLOSE="--\>";d.TRIM=!0;d.ASYNC=!0;d.STREAM=!1;d.ESCAPE=!0;d.SAFEMODE=!0;d.ENCODING="utf-8";d.ROOT_DIR="";d.COMPILE_DIR="";d.fetch=function(a,d){var e=new this(a),g=b.defer(),c="";e.set(d).on("data",function(a){c+=a}).on("end",function(a){g.resolve(a===f?c:a)}).fetch();return g.promise()};d.fromString=function(a,
b){return(new this(b)).loadString(a)};d.engine=function(a){"string"==typeof a&&(a=p("./"+a));var f=this.prototype;f._super={};b.each(a.statics,function(a,b){this[b]=a},this);b.each(a.fn,function(a,b){var c=f[b];c&&(f._super[b]=c);f[b]=a});return d};"undefined"!==typeof o?o("./AsyncTpl",d):module.exports=d})(p("./utils"),p("./Parser"),p("./Compiler"));(function(b,j){var m={fn:{_defaults:function(f){return this._super._defaults.call(this,b.extend({ns:this.self.NS},f||{},{firstLine:!1}))},_trans:function(f,
d){var k=[],i,a=f.attributes;if(f.ns!=this._opts.ns){if(f.type==f.ELEMENT_NODE)if(!f.__empty&&f.__close)k.push("</"+f.name+">");else{k.push("<"+f.name);var h=RegExp(this._opts.ns+":","i");b.each(a,function(a){h.test(a.value)?k.push(" "+a.name+'="',{name:"value",value:this.escape(a.value.replace(h,""))},'"'):k.push(" "+a.name+'="'+a.value+'"')},this);k.push(f.__empty?"/>":">")}}else switch(f.name){case "if":i=a.test&&a.test.value;break;case "choose":this.__choose=f.__open?1:0;break;case "when":i=f.__close?
"}":(1==this.__choose?"":" else ")+"if("+this.safe(a.test.value)+"){";this.__choose++;break;case "otherwise":i=f.__close?"}":" else {";break;case "foreach":a={from:a.iterate,key:a.index,item:a.as};break;case "value":i=this.escape(d.shift().value);d.shift();break;case "include":i=a.src.value;break;case "comment":f.type=f.TEXT_NODE;f.__empty?i="":(i="<\!--"+d.shift().value+"--\>",d.shift());break;case "text":f.type=f.TEXT_NODE,i=d.shift().value,d.shift()}if(i!==j)f.value=i;f.attributes=a;return k.length?
k:this._super._trans.call(this,f,d)}}};"undefined"!==typeof o?o("./XML",m):module.exports=m})(p("./utils"));C.AsyncTpl=p("AsyncTpl");var t={},v=p("utils");AsyncTpl.fetch=function(b,j,m){"string"!=typeof j&&(m=j,j=w);if(t[b]===w)if("#"==b.charAt(0)){var f=v.$(b)||{innerHTML:"[["+b+" \u2014 not found]]"};t[b]=new this;t[b].loadString(f.innerHTML)}else t[b]=new this(b);var d=v.defer(),k="";t[b].set(m||{}).on("data",function(b){k+=b}).on("end",function(b){d.resolve(b===w?k:b)}).fetch();j&&d.done(function(b){var a=
v.$(j);if(a)a.innerHTML=b});return d.promise()};if("undefined"!=typeof jQuery)jQuery.tpl=function(b){AsyncTpl.engine(b);jQuery.tpl=function(){return this};return this},jQuery.fn.tpl=function(b,j){jQuery.tpl("XML").fetch(b,this[0],j);return this}})(this);
